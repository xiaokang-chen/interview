# Mysql

[toc]

## 一、基础

### 1.1 SQL执行流程

![SQL执行流程](/pic/SQL执行流程.jpg)

1. 连接器建立连接
2. 查询缓存（MySQL8.0已删除）
3. 解析SQL：词法分析、语法分析、构建语法树
4. 执行SQL：预处理、优化、执行

### 1.2 记录的存储

MySQL 存储的行为是由存储引擎实现的，默认是InnoDB。
数据库创建一张表，会在文件系统中创建三个文件（8.0之前，8.0之后只会创建idb）：

1. db.opt
2. frm表结构文件
3. ibd表数据文件

如果要是开启表分区，那么一个表分区就会对应一个ibd文件。

### 1.3 InnoDB逻辑存储结构

表空间由段（segment）、区（extent）、页（page）、行（row）组成

![InnoDB逻辑存储结构](/pic/InnoDB逻辑存储结构.jpg)

1. 行（row）
    数据表中的记录都是按行进行存放的，每行记录根据不同的行格式，有不同的存储结构。

    `行格式`就是一条记录的存储结构，InnoDB提供了4种行格式：

    - Redundant（弃用）
    - **Compact**
    - Dynamic（紧凑型，基于Compact）
    - Compressed（紧凑型，基于Compact）

2. 页（page）
记录是按照行来存储的，但是数据库的读取并不以「行」为单位，否则一次读取（也就是一次 I/O 操作）只能处理一行数据，效率会非常低。
InnoDB 的数据是按「页」为单位来读写的，默认每个页大小为16K，数据表中的行记录用【数据页】来管理。

3. 区（extent）
InnoDB 存储引擎是用 B+ 树来组织数据的。B+ 树中每一层都是通过双向链表连接起来的，如果是以页为单位来分配存储空间，那么链表中相邻的两个页之间的物理位置并不是连续的，可能离得非常远，那么磁盘查询时就会有大量的随机I/O，随机 I/O 是非常慢的。
所以为了使链表中相邻的页的物理位置也相邻（便于顺序I/O），在范围查询（扫描叶子节点）时性能变高：
**在表中数据量大的时候，为某个索引分配空间的时候就不再按照页为单位分配了，而是按照区（extent）为单位分配。每个区的大小为 1MB，对于 16KB 的页来说，连续的 64 个页会被划为一个区，这样就使得链表中相邻的页的物理位置也相邻，就能使用顺序 I/O 了。**

4. 段（segment）
段一般分为数据段、索引段、回滚段等：

- 索引段：存放 B + 树的非叶子节点的区的集合；
- 数据段：存放 B + 树的叶子节点的区的集合；
- 回滚段：存放回滚数据的区的集合；

### 1.4 Compact行格式


## 二、索引

## 三、事务

## 四、锁

## 五、日志

## 六、内存

## 面试题

1. MySQL 中 InnoDB 和 MyISAM 的联系与区别

MySQL数据库对多引擎有很好的兼容，一个数据库中多个表可以使用不同的引擎。

- 对事务要求比较高的表选用InnoDB；
- 对查询要求比较高的选用MyISAM；
- 需要查询的临时表，选用MEMORY（Hash based，存储在内存中）；

区别：

- 事务：InnoDB支持事务，MyISAM不支持；
- 外键：InnoDB支持外键，MyISAM不支持；
- 存储引擎原理：两种引擎都是B+树。MyISAM 中 B+ 树的数据结构存储的内容是实际数据的地址值，它的索引和实际数据是分开的，这种索引的模式被称为非聚集索引；InnoDB 中 B+ 树的数据结构中存储的都是实际的数据，这种索引有被称为聚集索引；
- 索引：MyISAM-非聚集索引；InnoDB-聚集索引；

**MyISAM索引：**
MyISAM 中索引检索的算法为首先按照 B+Tree 搜索算法搜索索引，如果指定的 Key 存在，则取出其 data 域的值，然后以 data 域的值为地址，读取相应数据记录。
![MyISAM索引](/pic/MyISAM索引.jpg)

**InnoDB索引：**
由于 InnoDB 利用的数据库主键作为索引 Key，所以 InnoDB 数据表文件本身就是主索引，且因为 InnoDB 数据文件需要按照主键聚集，所以使用 InnoDB 作为数据引擎的表需要有个主键，如果没有显式指定的话 MySQL 会尝试自动选择一个可以唯一标识数据的列作为主键，如果无法找到，则会生成一个隐含字段作为主键，这个字段长度为6个字节，类型为长整形
![InnoDB索引](/pic/InnoDB索引.jpg)

总结：

1. MyISAM管理非事务表，它提供高速存储和检索。如果应用中需要执行大量的SELECT查询，那么MyISAM是更好的选择。
2. InnoDB用于事务处理应用程序。如果应用中需要执行大量的INSERT或UPDATE操作，则应该使用InnoDB，这样可以提高多用户并发操作的性能。
