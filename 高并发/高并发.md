# 高并发

[toc]

## 一、如何理解高并发

高并发意味着大流量，需要运用技术手段抵抗流量的冲击，这些手段好比操作流量，能让流量更平稳地被系统所处理，带给用户更好的体验。

常见的高并发场景有：淘宝的双11、春运时的抢票、微博大V的热点新闻等。除了这些典型事情，每秒几十万请求的秒杀系统、每天千万级的订单系统、每天亿级日活的信息流系统等，都可以归为高并发。

**到底多大QPS才算高并发：**

一般上百的量级就可以叫高并发了，微博每天1亿多pv的系统一般也就1500QPS，5000QPS峰值；

1. 不能只看数字，不能说10W QPS的秒杀系统就是高并发，而1W QPS的信息流就不是高并发。信息流在业务复杂度上比秒杀系统复杂的多，因此不在一个纬度，没有比较的意义。
2. 业务都是从0到1做起来的，并发量只是参考指标。重要的是业务体量在扩展到原来的10倍、100倍后，你是否通过高并发的处理方法去演进系统。通过架构设计、编码实现甚至产品方案去解决高并发问题，而不是通过升级硬件或加机器去进行水平扩展。

## 二、高并发系统设计的目标

### 2.1 宏观目标

从宏观角度，高并发系统设计的目标有三个：高性能、高可用、高扩展

![高可用目标](/pic/高可用目标.jpg)

1. 高性能
性能体现了系统的并行处理能力，在有限的硬件投入下，提高性能意味着节省成本。同时，性能也反映了用户体验，响应时间分别是100毫秒和1秒，给用户的感受是完全不同的。
2. 高可用
表示系统可以正常服务的时间。一个全年不停机、无故障；另一个隔三差五出线上事故、宕机，用户肯定选择前者。如果系统只能做到90%可用，会大大拖累业务。
3. 高扩展
表示系统的扩展能力，流量高峰时能否在短时间内完成扩容，更平稳地承接峰值流量，比如双11活动、微博大V热点事件。

3个目标是需要通盘考虑。考虑高可用时，会将服务接口设置超时时间，以防大量线程阻塞在慢请求上导致系统雪崩；考虑高扩展时，会将服务设计为无状态的（服务部署到多态机器，请求到任意机器处理结果都是一样的，服务不存储业务的上下文信息-比如session）

### 2.2 微观目标

再从微观角度来看，高性能、高可用和高扩展又有哪些具体的指标来衡量？

1. 性能指标

    - 平均响应时间：对慢请求不敏感；
    - TP90、TP99分位值（满足90%、99%的网络请求所需的最低耗时）：对慢请求敏感；
    - 吞吐量（QPS）：和响应时间成反比，比如响应时间1ms，吞吐量为每秒1000次；

2. 可用性指标
高可用性是指系统具有较高的无故障运行能力，可用性 = 正常运行时间 / 系统总运行时间，一般使用几个9来描述系统的可用性。对于高并发系统来说，最基本的要求是：保证3个9或者4个9。
3. 扩展性指标
面对突发流量，不可能临时改造架构，最快的方式就是增加机器来线性提高系统的处理能力。
对于业务集群或者基础组件来说，扩展性 = 性能提升比例 / 机器增加比例，理想的扩展能力是：资源增加几倍，性能提升几倍。通常来说，扩展能力要维持在70%以上。通常整个服务链路上MySQL、Redis、MQ会成为扩展过程中新的瓶颈点。
因此，高扩展性需要考虑：服务集群、数据库、缓存和消息队列等中间件、负载均衡、带宽、依赖的第三方等，当并发达到某一个量级后，上述每个因素都可能成为扩展的瓶颈点。

## 三、高并发的实践方案

### 3.1 通用设计方案

通用的设计方法：【纵向扩展】和【横向扩展】

1. 纵向扩展：提升单机处理能力

    - 提升单机硬件：加内存、cpu核数、带宽
    - 提升单机软件 使用缓存降低I/O次数、使用并发和异步的方式增加吞吐量

2. 横向扩展：集群部署

    - 做好分层架构：比如引入CDN加速静态资源、Web层统一的API网关、业务服务层按照垂直业务做微服务化、存储层各种异构数据库；
    - 各层做好水平扩展：无状态水平扩容，有状态做分片路由；像redis、mysql这种有状态的还可以通过主从同步、读写分离的方案提高读性能；

### 3.2 具体实践方案

1. 高性能实践方案

    - 集群部署
    - 多级缓存，包括CDN、内存缓存
    - 分库分表、索引优化
    - 引入NoSQL，如HBase、TiDB
    - 异步化，将次要流程通过多线程、MQ，甚至延迟任务进行异步处理
    - 并发处理，通过多线程将串行逻辑并行化
    - 减少I/O次数，数据库和缓存的批量读写（pipeline）、RPC的批量接口支持
    - 利用各种池化技术，比如HTTP请求池、线程池、数据库或Redis连接池
    - 锁选择，读多写少的场景用乐观锁

    上述方案无外乎都是从计算和I/O两个维度去考虑优化

2. 高可用实践方案

    - 对等节点的故障转移，服务治理框架支持一个节点失败后访问另一个节点
    - 非对等节点的故障转移，通过心跳检测来实施主备切换（比如redis哨兵和集群、MySQL主从切换）
    - 接口层面设置超时时间、重试、对冲策略
    - 限流、熔断、降级
    - 灰度发布
    - 监控告警
    - 巡检、灾备演练：对系统进行一些破坏性手段，观察局部故障是否会引发可用性问题

3. 高扩展实践方案

    - 合理的分层架构
    - 存储层的拆分，比如分库分表
    - 业务层拆分，拆微服务：可以按照业务维度，也可以按照核心和非核心维度，也可以按照请求源（TOB、后台管理、TOC、小程序）

## 参考

https://www.zhihu.com/question/421237964/answer/2999786814?utm_id=0